version: "0.29.0"

definitions:
  selector:
    extractor:
      field_path:
        - "{{ parameters['name'] }}"
  requester:
    url_base: "https://api.twilio.com/2010-04-01"
    http_method: "GET"
    authenticator:
      type: BasicHttpAuthenticator
      username: "{{ config['account_sid'] }}"
      password: "{{ config['auth_token'] }}"
  datetime_cursor:
    type: "DatetimeBasedCursor"
    start_datetime:
      datetime: "{{ config['start_date'] }}"
      datetime_format: "%Y-%m-%d"
    end_datetime:
      datetime: "{{ now_utc() }}"
      datetime_format: "%Y-%m-%d %H:%M:%S.%f+00:00"
    step: "P1D"
    datetime_format: "%Y-%m-%d"
    cursor_granularity: "P1D"
    cursor_field: "date"
  retriever:
    record_selector:
      $ref: "#/definitions/selector"
    requester:
      $ref: "#/definitions/requester"
  default_paginator:
    type: "DefaultPaginator"
    page_size_option:
      inject_into: "request_parameter"
      field_name: "PageSize"
    pagination_strategy:
      type: "CursorPagination"
      cursor_value: "{{response['next_page_uri']}}"
      page_size: 50
    page_token_option:
      type: RequestPath
  base_stream:
    retriever:
      $ref: "#/definitions/retriever"
  base_stream_with_pagination:
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"

  accounts_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "accounts"
      path: "/Accounts.json"
      primary_key: "sid"
  
  accounts_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/accounts_stream"
        parent_key: sid
        partition_field: id

  addresses_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "addresses"
      path: "/Accounts/{{ stream_slice.id }}/Addresses.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
  
  alerts_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "alerts"
      path: "/Alerts"
      primary_key: "sid"
    requester:
      url_base: "https://monitor.twilio.com/v1"
  
  applications_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "applications"
      path: "Accounts/{{stream_slice.account_id}}/Applications.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  available_phone_number_countries_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "available_phone_number_countries"
      path: "/Accounts/{{stream_ slice.account_.id}}/AvailablePhoneNumbers.json"
      primary_key: ""
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
    
  available_phone_numbers_countries_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/available_phone_number_countries_stream"
        parent_key: ""
        partition_field: subresource_uris
  
  conversations_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "conversations"
      path: "/Conversations"
      primary_key: "sid"
    requester:
      url_base: "https://conversations.twilio.com/v1"
  
  conversations_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/conversations_stream"
        parent_key: sid
        partition_field: conversations_id

  conversation_messages_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "conversation_messages"
      path: "/Conversations/{{stream_slice.conversations_id}}/Messages"
      primary_key: "sid"
    requester:
      url_base: "https://conversations.twilio.com/v1"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/conversations_partition_router"

  conversation_participants_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "conversation_messages"
      path: "/Conversations/{{stream_slice.conversations_id}}/Participants"
      primary_key: "sid"
    requester:
      url_base: "https://conversations.twilio.com/v1"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/conversations_partition_router"

  flows_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "flows"
      path: "/Flows"
      primary_key: "sid"
    requester:
      url_base: "https://studio.twilio.com/v1"

  flows_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
    - stream: "#/definitions/flows_stream"
      parent_key: sid
      partition_field: flow_id

  executions_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "executions"
      path: "/Flows/{{stream_slice.flow_id}}/Executions"
      primary_key: "sid"
    requester:
      url_base: "https://studio.twilio.com/v1"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/flows_partition_router"
  

streams:
  - "#/definitions/accounts_stream"
  - "#/definitions/addresses_stream"
  - "#/definitions/alerts_stream"
  - "#/definitions/applications_stream"
  - "#/definitions/available_phone_number_countries_stream"
  - "#/definitions/conversation_messages_stream"
  - "#/definitions/conversation_participants_stream"
  - "#/definitions/conversations_stream"
  - "#/definitions/flows_stream"
  - "#/definitions/executions_stream"
  

check:
  stream_names:
    - "accounts"
    - "addresses"
    - "alerts"
    - "applications"
    - "available_phone_number_countries"
    - "flows"
    - "executions"
    - "conversation_messages"
    - "conversation_participants"
    - "conversations"
    