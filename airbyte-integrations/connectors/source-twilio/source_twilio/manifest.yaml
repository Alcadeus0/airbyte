version: "0.29.0"

definitions:
  selector:
    extractor:
      field_path:
        - "{{ parameters['name'] }}"
  requester:
    url_base: "https://api.twilio.com/2010-04-01"
    http_method: "GET"
    authenticator:
      type: BasicHttpAuthenticator
      username: "{{ config['account_sid'] }}"
      password: "{{ config['auth_token'] }}"
  datetime_cursor:
    type: "DatetimeBasedCursor"
    start_datetime:
      datetime: "{{ config['start_date'] }}"
      datetime_format: "%Y-%m-%d"
    end_datetime:
      datetime: "{{ now_utc() }}"
      datetime_format: "%Y-%m-%d %H:%M:%S.%f+00:00"
    step: "P1D"
    datetime_format: "%Y-%m-%d"
    cursor_granularity: "P1D"
    lookback_window: "{{ config['lookback_window']}}"
    cursor_field: "date"
  retriever:
    record_selector:
      $ref: "#/definitions/selector"
    requester:
      $ref: "#/definitions/requester"
  default_paginator:
    type: "DefaultPaginator"
    page_size_option:
      inject_into: "request_parameter"
      field_name: "PageSize"
    pagination_strategy:
      type: "CursorPagination"
      cursor_value: "{{response['next_page_uri']}}"
      page_size: 50
    page_token_option:
      type: RequestPath
  base_stream:
    retriever:
      $ref: "#/definitions/retriever"
  base_stream_with_pagination:
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        $ref: "#/definitions/default_paginator"

  accounts_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "accounts"
      path: "/Accounts.json"
      primary_key: "sid"
  
  accounts_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/accounts_stream"
        parent_key: sid
        partition_field: id

  addresses_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "addresses"
      path: "/Accounts/{{ stream_slice.id }}/Addresses.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
  
  addresses_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/addresses_stream"
        parent_key: sid
        partition_field: address_id
  
  alerts_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "alerts"
      path: "/Alerts"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        type: HttpRequester
        url_base: "https://monitor.twilio.com/v1"
        http_method: "GET"
        authenticator:
          type: BasicHttpAuthenticator
          username: "{{ config['account_sid'] }}"
          password: "{{ config['auth_token'] }}"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "date_generated"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"

  applications_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "applications"
      path: "Accounts/{{stream_slice.id}}/Applications.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  available_phone_number_countries_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "available_phone_number_countries"
      path: "/Accounts/{{stream_ slice.id}}/AvailablePhoneNumbers.json"
      primary_key: "country_code"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
    
  available_phone_number_countries_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/available_phone_number_countries_stream"
        parent_key: "country_code"
        partition_field: country_code

  available_phone_numbers_local_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "available_phone_numbers_local"
      path: "/Accounts/{{stream_slice.account_id}}/AvailablePhoneNumbers/{{stream_slice.country_code}}/Local.json"
      primary_key: "iso_country"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/available_phone_number_countries_partition_router"

  available_phone_numbers_mobile_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "available_phone_numbers_mobile"
      path: "/Accounts/{{stream_slice.account_id}}/AvailablePhoneNumbers/{{stream_slice.country_code}}/Mobile.json"
      primary_key: "iso_country"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/available_phone_number_countries_partition_router"

  available_phone_numbers_toll_free_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "available_phone_numbers"
      path: "/Accounts/{{stream_slice.account_id}}/AvailablePhoneNumbers/{{stream_slice.country_code}}/TollFree.json"
      primary_key: "iso_country"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/available_phone_number_countries_partition_router"
  
  
  conferences_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "conferences"
      path: "/Accounts/{{stream_slice.id}}/Conferences.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "date_created"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"

  conferences_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/conferences_stream"
        parent_key: sid
        partition_field: conferences_id
  
  conference_participants_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "conferences_participants"
      path: "/Accounts/{{stream_slice.id}}/Conferences/{{ stream_slice.conferences_id}}/Participants.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/conferences_partition_router"

  conversations_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "conversations"
      path: "/Conversations"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        type: HttpRequester
        url_base: "https://conversations.twilio.com/v1"
        http_method: "GET"
        authenticator:
          type: BasicHttpAuthenticator
          username: "{{ config['account_sid'] }}"
          password: "{{ config['auth_token'] }}"

  conversations_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/conversations_stream"
        parent_key: sid
        partition_field: conversations_id

  conversation_messages_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "conversation_messages"
      path: "/Conversations/{{stream_slice.conversations_id}}/Messages"
      primary_key: "sid"
    requester:
      url_base: "https://conversations.twilio.com/v1"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/conversations_partition_router"

  conversation_participants_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "conversation_participants"
      path: "/Conversations/{{stream_slice.conversations_id}}/Participants"
      primary_key: "sid"
    requester:
      url_base: "https://conversations.twilio.com/v1"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/conversations_partition_router"
    
  dependent_phone_numbers_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "dependent_phone_numbers"
      path: "/2010-04-01/Accounts/{{stream_slice.id}}/Addresses/{{stream_slice.address_id}}/DependentPhoneNumbers.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/addresses_partition_router"
  
  incoming_phone_numbers_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "incoming_phone_numbers"
      path: "/Accounts/{{stream_slice.id}}/IncomingPhoneNumbers.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
  
  keys_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "keys"
      path: "/Accounts/{{stream_slice.id}}/Keys.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"

  flows_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "flows"
      primary_key: "sid"
      path: "/Flows"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        type: HttpRequester
        url_base: "https://studio.twilio.com/v1"
        http_method: "GET"
        authenticator:
          type: BasicHttpAuthenticator
          username: "{{ config['account_sid'] }}"
          password: "{{ config['auth_token'] }}"
      paginator:
        $ref: "#/definitions/default_paginator"

  flows_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
    - stream: "#/definitions/flows_stream"
      parent_key: sid
      partition_field: flow_id

  executions_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "executions"
      path: "/Flows/{{stream_slice.flow_id}}/Executions"
      primary_key: "sid"
    requester:
      url_base: "https://studio.twilio.com/v1"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/flows_partition_router"
  
  outgoing_caller_ids_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "outgoing_caller_ids"
      path: "/Accounts/{{stream_slice.id}}/OutgoingCallerIds"
      primary_key: ""
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
  
  queues_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "queues"
      path: "/Accounts/{{stream_slice.id}}/Queues.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
  
  transcriptions_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "transcriptions"
      path: "/Accounts/{{stream_slice.id}}/Transcriptions.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
  
  messages_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "messages"
      path: "/Accounts/{{stream_slice.id}}/Messages.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "date_sent"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"

  messages_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/conferences_stream"
        parent_key: sid
        partition_field: message_id

  message_media_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "message_media"
      path: "/Accounts/{{stream_slice.id}}/Messages/{{stream_slice.message_id}}/Media.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "date_created"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"
  
  usage_records_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "usage_records"
      path: "/Accounts/{{stream_slice.id}}/Usage/Records.json"
      primary_key: 
        - "account_sid"
        - "category"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "start_date"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"
  
  usage_triggers_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "usage_triggers"
      path: "/Accounts/{{stream_slice.id}}/Usage/Triggers.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
  
  recordings_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "recordings"
      path: "/Accounts/{{stream_slice.id}}/Recordings.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "date_created"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"
  


  calls_stream:
    $ref: "#/definitions/base_stream_with_pagination"
    $parameters:
      name: "alerts"
      path: "/Accounts/{{stream_slice.id}}/Calls.json"
      primary_key: "sid"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        $ref: "#/definitions/default_paginator"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: "end_time"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
        cursor_granularity: "PT0.000001S"
        step: "P1D"

streams:
  - "#/definitions/accounts_stream"
  - "#/definitions/addresses_stream"
  - "#/definitions/alerts_stream"
  - "#/definitions/applications_stream"
  - "#/definitions/available_phone_number_countries_stream"
  - "#/definitions/available_phone_numbers_local_stream"
  - "#/definitions/available_phone_numbers_mobile_stream"
  - "#/definitions/available_phone_numbers_toll_free_stream"
  - "#/definitions/calls_stream"
  - "#/definitions/conference_participants_stream"
  - "#/definitions/conferences_stream"
  - "#/definitions/conversation_messages_stream"
  - "#/definitions/conversation_participants_stream"
  - "#/definitions/conversations_stream"
  - "#/definitions/dependent_phone_numbers_stream"
  - "#/definitions/flows_stream"
  - "#/definitions/executions_stream"
  - "#/definitions/incoming_phone_numbers_stream"
  - "#/definitions/keys_stream"
  - "#/definitions/message_media_stream"
  - "#/definitions/messages_stream"
  - "#/definitions/outgoing_caller_ids_stream"
  - "#/definitions/queues_stream"
  - "#/definitions/recordings_stream"
  - "#/definitions/transcriptions_stream"
  - "#/definitions/usage_records_stream"
  - "#/definitions/usage_triggers_stream"


check:
  stream_names:
    - "accounts"
    - "addresses"
    - "alerts"
    - "applications"
    - "available_phone_number_countries"
    - "available_phone_numbers_local"
    - "available_phone_numbers_mobile"
    - "available_phone_numbers_toll_free"
    - "calls"
    - "conference_participants"
    - "conferences"
    - "conversation_messages"
    - "conversation_participants"
    - "conversations"
    - "dependent_phone_numbers"
    - "executions"
    - "flows"
    - "incoming_phone_numbers"
    - "keys"
    - "message_media"
    - "messages"
    - "outgoing_caller_ids"
    - "queues"
    - "recordings"
    - "transcriptions"
    - "usage_records"
    - "usage_triggers"